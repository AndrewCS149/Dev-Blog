@page
@model Dev_Blog.Pages.Status.PostsModel
@{
    ViewData["Title"] = "Updates";
    Layout = "_Layout";
}
<head>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <link rel="stylesheet" type="text/css" href="~/css/Posts.css" />
    <title>Status</title>
</head>
<body id="bootstrap-override">
    <main>
        <div class="container">
            @{
                if (User.Identity.IsAuthenticated)
                {
                    if (User.Identity.Name == Model.AdminUser)
                    {
                        <a id="add-post" class="btn btn-primary" asp-page="Add">Add Post</a>
                    }
                }
                if (Model.Posts != null)
                {
                    <!-- All Posts -->
                    foreach (var post in Model.Posts)
                    {
                        <div class="card">
                            <div class="card-header">
                                <span>
                                    Update
                                    <strong>@post.UpdateNum</strong>
                                </span>
                                <div class="float-right">
                                    <strong>@post.Date.ToShortDateString()</strong>

                                    <!-- Delete post form -->
                                    @if (User.Identity.Name == Model.AdminUser)
                                    {
                                        <form method="post" class="delete-form">
                                            <input hidden asp-for=@post.Id>
                                            <button asp-page-handler="Delete" type="submit">
                                                @{ await Html.RenderPartialAsync("../Icons/_TrashIcon");}
                                            </button>
                                            <a class="nav-link" asp-route-id=@post.Id asp-page="Edit">
                                                @{ await Html.RenderPartialAsync("../Icons/_EditIcon");}
                                            </a>
                                        </form>
                                    }
                                </div>
                            </div>

                            <!-- Post Information -->
                            <div class="card-body text-center">
                                <img class="update-img" src=@post.ImgURL />
                                <p>@post.Description</p>
                            </div>

                            @if (post.Comments != null)
                            {
                                <!--Delete Comment Button-->
                                foreach (var comment in post.Comments)
                                {
                                    <div class="posted-comments comment-box" style="padding: 7.5px">
                                        <span class="comment-username">@comment.UserName</span>
                                        <div class="float-right">
                                            <span>@comment.Date.ToString("MM/dd/yyyy hh:mm tt")</span>
                                            <form method="post" class="delete-form">
                                                @if (User.Identity.Name == Model.AdminUser)
                                                {
                                                    <input hidden asp-for=@comment.Id>
                                                    <button type="submit" asp-page-handler="DeleteComment">
                                                        @{ await Html.RenderPartialAsync("../Icons/_TrashIcon");}
                                                    </button>
                                                }
                                            </form>
                                        </div>
                                        <p>@comment.Content</p>
                                    </div>
                                }
                            }

                            <!-- Comment Box -->
                            <div class="comment-box form-group">
                                @if (User.Identity.IsAuthenticated)
                                {
                                    <form>
                                        <textarea id="comment" asp-for=@Model.Comment.Content class="form-control" placeholder="comment..." rows="2"></textarea>
                                        <input id="postId" hidden asp-for="@post.Id" value=@post.Id />
                                        <button id="commentBtn" class="btn btn-secondary">Comment</button>
                                    </form>
                                }
                                else
                                {
                                    <textarea class="form-control" placeholder="Login in to leave comments"></textarea>
                                }
                            </div>
                        </div>
                    }
                }
            }
        </div>
    </main>
    <script>
        // submit comment ajax call
        $(document).ready(function () {
            $('#commentBtn').on("click", function (e) {

                var comment = {
                    PostId: parseInt($("#postId").val()),
                    Content: $("#comment").val()
                }

                $.ajax({
                    contentType: "application/json; charset=utf-8",
                    type: "POST",
                    url: "/Test",
                    data: JSON.stringify(comment),
                    dataType: "json",
                    success: function (data, status) {
                        console.log(status);
                    },
                    error: function (e) {
                        console.log(e);
                    }
                });
                e.preventDefault();
            });
        });
    </script>
</body>