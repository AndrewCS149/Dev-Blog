@page "/posts"

@using Pages.Modals

@inject IHttpContextAccessor _http
@inject IPosts _posts
@inject IComments _comments
@inject IVotes _votes
@inject AuthenticationStateProvider Auth
@inject Data.AppDbContext DB
@inject IModalService _modal
@inject IJSRuntime JS

@if (AllPosts == null)
{
    <p>Loading...</p>
}
else
{
    <!-- Add Post -->
    <AuthorizeView Policy="Admin">
        <button @onclick=ShowAddPost>Add Post</button>
    </AuthorizeView>

    <!-- Page left / right -->
    @*<Paginate />*@

    <div>
        <button @onclick="@(e => NavTo("prev"))">PREV</button>
        @for (int i = 0; i < TotalPgs; i++)
        {
            var pgNum = i;
            <button style="background-color: @(CurrentPg == pgNum ? "#382424" : "#845555")" @onclick="@(e => UpdateList(pgNum))">
                @(i + 1)
            </button>
        }
        <button @onclick="@(e => NavTo("next"))">NEXT</button>
    </div>

    <!-- Render Posts -->
    @foreach (var post in PostsPage)
    {
        <div style="margin-top: 20px;">
            <div>
                <span>@post.UpdateNum</span>
                <span>@post.Date.ToShortDateString()</span>

                <!-- Delete / Edit Post -->
                <AuthorizeView Policy="Admin">
                    <button @onclick="@(() => ShowEditPost(post.Id))">
                        <EditIcon />
                    </button>

                    <button @onclick="() => DeletePost(post.Id)">
                        <TrashIcon />
                    </button>
                </AuthorizeView>
            </div>

            <img src=@post.ImgURL />
            <p>@post.Description</p>

            <!-- Voting System -->
            <AuthorizeView>
                <Authorized>
                    <div>
                        <button @onclick="async () => await _votes.UpVote(post.Id, _http.HttpContext.User.Identity.Name)" class="glyphicon glyphicon-thumbs-up"></button>
                        <span>@post.UpVotes.Count</span>
                        <button @onclick="async () => await _votes.DownVote(post.Id, _http.HttpContext.User.Identity.Name)" class="glyphicon glyphicon-thumbs-down"></button>
                        <span>@post.DownVotes.Count</span>
                    </div>
                </Authorized>
                <NotAuthorized>
                    <div>
                        <button class="glyphicon glyphicon-thumbs-up"></button>
                        <span>@post.UpVotes.Count</span>
                        <button class="glyphicon glyphicon-thumbs-down"></button>
                        <span>@post.DownVotes.Count</span>
                        <span>Login in to Like / Dislike</span>
                    </div>
                </NotAuthorized>
            </AuthorizeView>

            <!-- Render Comments -->
            <div>
                @if (post.Comments != null)
                {
                    foreach (var comment in post.Comments)
                    {
                        <div>
                            <span>@comment.UserName</span>
                            <span> @comment.Date.ToString("MM/dd/yyyy hh:mm tt") </span>

                            <!-- Delete / Edit Comment -->
                            <AuthorizeView Policy="Admin">
                                <button @onclick="async () => await _comments.Delete(comment.Id)">
                                    <TrashIcon />
                                </button>
                            </AuthorizeView>
                            @*@if (!admin)
                                {*@
                            <AuthorizeView Policy="Visitor">
                                @if (comment.UserName == _http.HttpContext.User.Identity.Name)
                                {
                                    <button @onclick="async () => await _comments.Delete(comment.Id)">
                                        <TrashIcon />
                                    </button>
                                }
                            </AuthorizeView>
                            @*}*@

                            <p>@comment.Content</p>
                        </div>
                    }
                }
            </div>

            <!-- Add Comment -->
            <div>
                <AuthorizeView>
                    <Authorized Context=" Auth">
                        <EditForm Model=@comment OnValidSubmit="() => AddComment(post.Id)">
                            <InputTextArea @bind-Value=comment.Content DisplayName="Add a comment..." />
                            <button type="submit">Comment</button>
                        </EditForm>
                    </Authorized>

                    <NotAuthorized>
                        <textarea placeholder="Login in to leave a comment..">
                        </textarea>
                    </NotAuthorized>
                </AuthorizeView>
            </div>
        </div>
    }
}

@code {
    CommentVM comment;

    public List<PostModel> PostsPage { get; set; }

    public List<PostModel> AllPosts { get; set; }

    public int PgSize { get; set; }
    public int TotalPgs { get; set; }
    public int CurrentPg { get; set; }

    protected override async Task OnInitializedAsync()
    {
        comment = new CommentVM();
        AllPosts = await _posts.GetPosts();

        PgSize = 5;
        PostsPage = AllPosts.Take(PgSize).ToList();
        TotalPgs = (int)Math.Ceiling(AllPosts.Count() / (decimal)PgSize);
    }

    async Task ShowAddPost()
    {
        await _modal.Show<AddPost>("Add Post").Result;
        await OnInitializedAsync();
    }

    async Task ShowEditPost(int postId)
    {
        var param = new ModalParameters();
        param.Add(nameof(EditPost.Id), postId);
        await _modal.Show<EditPost>("Edit Post", param).Result;
        await OnInitializedAsync();
    }

    public async Task AddComment(int postId)
    {
        comment.UserName = _http.HttpContext.User.Identity.Name;
        comment.PostModelId = postId;

        await _comments.Create(comment);
        comment = new CommentVM();
    }

    public async Task DeletePost(int postId)
    {
        await _posts.Delete(postId);
        await OnInitializedAsync();
    }

    public void UpdateList(int pgNum)
    {
        PostsPage = AllPosts.Skip(pgNum * PgSize).Take(PgSize).ToList();
        CurrentPg = pgNum;
    }

    public async Task NavTo(string val)
    {
        if (val == "prev" && CurrentPg != 0)
            CurrentPg--;

        if (val == "next" && CurrentPg != TotalPgs - 1)
            CurrentPg++;

        UpdateList(CurrentPg);
    }

    public class CommentVM
    {
        public string UserName { get; set; }

        public int PostModelId { get; set; }

        public string Content { get; set; }
    }
}